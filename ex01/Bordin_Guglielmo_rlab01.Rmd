---
title: "R Laboratory – Exercise 1"
author: "Guglielmo Bordin"
date: "`r gsub('^0', '', format(Sys.Date(), '%d %B %Y'))`"
output:
    rmdformats::material:
        fig_width: 8
        fig_height: 5
        thumbnails: false
        lightbox: true
        gallery: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, dev = "svg")
```

# American Airlines Employees
## Reading Data
We begin by importing the `tidyverse` and setting `ggplot`-related stuff.
```{r}
library(tidyverse)
font <- "Fira Sans Condensed"
theme_set(theme_bw(base_size = 16, base_family = font))
my_palette <- unname(palette.colors(4, "Okabe-Ito"))
```
Now we can start importing data. Let’s first put each company’s data in a
separate tibble, and then merge them in a single one, adding a column with
the company name. Also, we’ll combine the `month` and `year` columns into 
a single date column (labeled as `month`).
```{r}
names <- c("month", "year", "full_time", "part_time", "total")
american <- read_table("data/american_airline_empl.txt",
                       skip = 1, col_names = names)
delta <- read_table("data/delta_airline_empl.txt",
                    skip = 1, col_names = names)
federal <- read_table("data/federal_express_empl.txt",
                      skip = 1, col_names = names)
united <- read_table("data/united_airline_empl.txt",
                      skip = 1, col_names = names)

# start with a named list to recover the names when binding rows
(employees <- list(american = american, delta = delta,
                   federal = federal, united = united) |>
    bind_rows(.id = "company") |>
    mutate(month = lubridate::make_date(year = year, month = month)) |>
    select(-year))
```
We’ll also keep track of properly-typeset version of the company and jobs
names, to use them later in the plots.
```{r}
full_names <- list(american = "American Airlines",
                   delta = "Delta Airlines",
                   federal = "Federal Express",
                   united = "United Airlines")
job_type <- list(full_time = "Full-time",
                 part_time = "Part-time",
                 total = "Total")
```

## Full-Time vs Part-Time Employees
Here we’ll generate a plot of the number of employees in time, for all 
four companies. We’ll keep the full-time and part-time workers’ numbers
separated, and also produce a plot with the total.
```{r}
lapply(names(job_type), function(idx) {
    employees |>
    ggplot(aes(x = month, y = .data[[idx]], colour = company)) +
        geom_line(linewidth = 0.8) +
        scale_colour_manual(values = my_palette, labels = full_names) +
        labs(x = "Year", y = "Number of employees", colour = "Company",
             title = paste(job_type[[idx]], "Employees"))
})
```

To answer the question of when did each company reach the minimum and 
maximum number of employees, we can directly work on `employees` with the 
`dplyr` functions `group_by` and `summarise`.

```{r}
(minmax <- employees |>
    group_by(company) |>
    summarize(min = min(total), when_min = month[which.min(total)],
              max = max(total), when_max = month[which.max(total)]))
```

Here we’ll plot the evolution in time of the fraction of part-time workers
over the total workforce of each company.
```{r}
employees |>
    mutate(part_time = 100 * part_time / total) |>
    ggplot(aes(x = month, y = part_time, colour = company)) +
        geom_line(linewidth = 0.8) +
        scale_colour_manual(values = my_palette, labels = full_names) +
        labs(x = "Year", y = "Part-time employees [%]",
             colour = "Company",
             title = "Fraction of part-time employees through the years")
```

## COVID-19 Effect
To analyse the influence of the COVID-19 pandemic, we can zoom in on the
period from 2019 to 2023 in the total workforce’s plot. We also add a 
reference line with the previously-found historic minima of the workforce.
```{r}
employees |>
    filter(lubridate::year(month) > 2018) |>
    ggplot(aes(x = month, y = total, colour = company)) +
        geom_line(linewidth = 0.8) +
        geom_hline(aes(yintercept = min, colour = company,
                       linetype = "Historic minimum"), minmax,
                   linewidth = 0.6) +
        scale_linetype_manual(name = "", values = rep("dashed", 4)) +
        scale_colour_manual(values = my_palette, labels = full_names) +
        labs(x = "Year", y = "Number of employees", colour = "Company",
             title = "Evolution of the workforce in the COVID years")
```

We see indeed that two out of four companies – Delta and United – took a 
deep hit from the pandemic, resulting in a depletion of the workforce 
almost to an all-time low, especially for Delta. American apparently felt
the crisis a bit less, but we can still observe a dip before the start of
2021.

Federal Express is, on the other hand, in complete contrast with the 
other three companies: its workforce even *grew* in the pandemic period.
This is perhaps not that surprising if we consider that FedEx is a giant
corporation that focuses on basically every aspect of transportation, not 
simply passenger air travel like the other three companies.

# New York City Flights