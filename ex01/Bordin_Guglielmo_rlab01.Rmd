---
title: R Laboratory – Exercise 1
author: Guglielmo Bordin
date: "`r gsub('^0', '', format(Sys.Date(), '%d %B %Y'))`"
output:
    rmdformats::readthedown:
        fig_width: 8
        fig_height: 5
        thumbnails: false
        lightbox: true
        gallery: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, dev = "svg")
```

# American Airlines Employees
## Reading Data
We begin by importing the `tidyverse` and setting `ggplot`-related stuff.
```{r}
library(tidyverse)
font <- "Lato"
theme_set(theme_minimal(base_size = 14, base_family = font))
my_palette <- unname(palette.colors(4, "Okabe-Ito"))
```
Now we can start importing data. Let’s first put each company’s data in a
separate tibble, and then merge them in a single one, adding a column with
the company name. Also, we’ll combine the `month` and `year` columns into 
a single date column (labeled as `month`).
```{r}
names <- c("month", "year", "full_time", "part_time", "total")
american <- read_table("data/american_airline_empl.txt",
                       skip = 1, col_names = names)
delta <- read_table("data/delta_airline_empl.txt",
                    skip = 1, col_names = names)
federal <- read_table("data/federal_express_empl.txt",
                      skip = 1, col_names = names)
united <- read_table("data/united_airline_empl.txt",
                      skip = 1, col_names = names)

# start with a named list to recover the names when binding rows
employees <- list(american = american, delta = delta,
                   federal = federal, united = united) |>
    bind_rows(.id = "company") |>
    mutate(month = make_date(year = year, month = month)) |>
    select(-year)
```
```{r, echo = FALSE, results = "asis"}
knitr::kable(head(employees), caption = "`employees` tibble")
```
We’ll also keep track of properly-typeset version of the company and jobs
names, to use them later in the plots.
```{r}
full_names <- list(american = "American Airlines",
                   delta = "Delta Airlines",
                   federal = "Federal Express",
                   united = "United Airlines")
job_type <- list(full_time = "Full-time",
                 part_time = "Part-time",
                 total = "Total")
```

## Full-Time vs Part-Time Employees
Here we’ll generate a plot of the number of employees in time, for all 
four companies. We’ll keep the full-time and part-time workers’ numbers
separated, and also produce a plot with the total.
```{r}
lapply(names(job_type), function(idx) {
    employees |>
    ggplot(aes(x = month, y = .data[[idx]], colour = company)) +
        geom_line(lwd = 0.8) +
        scale_colour_manual(values = my_palette, labels = full_names) +
        labs(x = "Year", y = "Number of employees", colour = "Company",
             title = paste(job_type[[idx]], "Employees"))
})
```

To answer the question of when did each company reach the minimum and 
maximum number of employees, we can directly work on `employees` with the 
`dplyr` functions `group_by` and `summarize`.

```{r}
minmax <- employees |>
    group_by(company) |>
    summarize(min = min(total), when_min = month[which.min(total)],
              max = max(total), when_max = month[which.max(total)])
```
```{r, echo = FALSE, results = "asis"}
knitr::kable(minmax)
```

Here we’ll plot the evolution in time of the fraction of part-time workers
over the total workforce of each company.
```{r}
employees |>
    mutate(part_time = 100 * part_time / total) |>
    ggplot(aes(x = month, y = part_time, colour = company)) +
        geom_line(lwd = 0.8) +
        scale_colour_manual(values = my_palette, labels = full_names) +
        labs(x = "Year", y = "Part-time employees [%]", colour = "Company")
```

## COVID-19 Effect
To analyse the influence of the COVID-19 pandemic, we can zoom in on the
period from 2019 to 2023 in the total workforce’s plot. We also add a 
reference line with the previously-found historic minima of the workforce.
```{r}
employees |>
    filter(lubridate::year(month) > 2018) |>
    ggplot(aes(x = month, y = total, colour = company)) +
        geom_line(lwd = 0.8) +
        geom_hline(aes(yintercept = min, colour = company,
                       linetype = "Historic minimum"),
                   minmax, lwd = 0.6) +
        scale_linetype_manual(name = "", values = rep("dashed", 4)) +
        scale_colour_manual(values = my_palette, labels = full_names) +
        labs(x = "Year", y = "Number of employees", colour = "Company")
```

We see indeed that two out of four companies – Delta and United – took a 
deep hit from the pandemic, resulting in a depletion of the workforce 
almost to an all-time low, especially for Delta. American apparently felt
the crisis a bit less, but we can still observe a dip before the start of
2021.

Federal Express is, on the other hand, in complete contrast with the 
other three companies: its workforce even *grew* in the pandemic period.
This is perhaps not that surprising if we consider that FedEx is a giant
corporation that focuses on basically every aspect of transportation, not 
simply passenger air travel like the other three companies.

# New York City Flights
The data we want to analyse here comes from the `nycflights13` package.

```{r}
library(nycflights13)
```

First, let’s have a look at the four tibbles in the dataset.
```{r, echo = FALSE, results = "asis"}
knitr::kable(head(airlines), caption = "`airlines` tibble")
knitr::kable(head(airports), caption = "`airports` tibble")
knitr::kable(head(flights), caption = "`flights` tibble")
knitr::kable(head(planes), caption = "`planes` tibble")
```

Now we’ll plot the total number of flights departing from each of the 
three NYC airports (JFK, LGA and EWR) as a function of time.
```{r}
flights$date <- as_date(flights$time_hour)

flights |>
    count(date, origin) |>
    ggplot(aes(x = date, y = n, colour = origin)) +
        geom_point(size = 0.8) +
        geom_smooth(aes(fill = origin), lwd = 0.8) +
        scale_colour_manual(values = my_palette) +
        scale_fill_manual(values = my_palette, guide = "none") +
        labs(x = "Date", y = "Number of flights", colour = "Airport") +
        guides(colour = guide_legend(override.aes = list(fill = NA)))
```

Another plot: this time, the average number of flights in the working days
of a week, as a function of the week number in the year. 
```{r}
somecols <- c("#297383", "#8bc5cd")
flights |>
    # get weekday and remove saturdays and sundays
    filter(!(wday(date) %in% c(1, 7))) |>
    # count flights by day and keep week number
    count(week = week(date), day) |>
    # regroup by week to get average by day
    group_by(week) |>
    summarize(avg = mean(n), sd = sd(n)) |>
    ggplot(aes(x = week, y = avg)) +
        geom_ribbon(aes(ymin = avg - sd, ymax = avg + sd),
                    alpha = 0.8, colour = "transparent",
                    fill = somecols[2]) +
        geom_line(colour = somecols[1], lwd = 0.8) +
        labs(x = "Week", y = "Average flights per day")
```